\subsection{Shared Medicine Record}
At the surface, this is a quite simple online system: for each person, maintain a list of current treatments, which may involve one or more prescriptions, and additionally a set of events that has occurred for the given treatment.

Not all treatments require prescriptions, i.e. the doctor can tell you to drink water, or take calcium tablets which you can get without a prescription, but he may make a prescription on these too. Everything prescribed will be in the system. Events are things that have happen in the real world, such as a drug being administered to a patient by a nurse, or a drug being handed out at a pharmacy. 

The wide adoption of this system builds upon a successful cross-sectoral standardisation of medicine workflows and closely related concepts. The system is not an electronic health record with specialised information such as test results, measurements or the like.

One of the primary design criteria for FMK is to provide high availability. The system is in use 24x7, and currently has 40+ integrations with other healthcare systems, most of which are required to use FMK as the primary storage for relevant medicines data. 

Though being simple at the high level, much of the challenge lies in making the system highly available, scalable and secure, supporting a wide range of use cases (as well as old APIs), at the same time that making sure that data flows in from many of the connected systems has some measure of consistency. In many cases data \textquotedblleft updates\textquotedblright{} are made on the basis of a previous\textquotedblleft query\textquotedblright{} to the system, and the system needs to have a model that captures conflicting updates. As such, this seemingly simple system ends up being surprisingly complex, especially because of the high availability requirement. 

In the context of making healthcare decisions, it is much better to have some information than none. Better to have old information than none. Events that happen \textquotedblleft outside\textquotedblright{} the system have indisputably happened, so the system needs to ingest them regardless of consistency. All this leads us down the road to a \gls{crdt}-like data model deployed on Riak (dynamo-style \gls{ec} w/write-conflict capture). The central patient information data model is essentially a stateful \gls{crdt}, that exposes a semantic model for write conflicts. Ideally, there would be a replica of the entire service+dataset in each major geographical region/hospital, which is still an eventual goal. Writes should be propagated \textquotedblleft as soon as possible\textquotedblright , but lack of such propagation - WAN failure - should not render the system unusable.


\subsubsection{Network Topology and Architecture }
The system is made up of geographically separated \glspl{dc}, set up in master-master replication mode, so any \gls{dc} can handle any request. The client systems are systems providers for \glspl{gp}, pharmacies and hospitals as well as a web based system that provides citizens access and acts as a backup for the professional systems. Each client has an affinity to a given primary \gls{dc}, so all requests from a given client use only one \gls{dc}, as long as it is available.


\subsubsection{Conflict Situations}
Because of the asynchronous client system interfaces, and distributed \glspl{dc}, two doctors can prescribe conflicting medicines to the same patient simultaneously. A real-life example of this is right after a patient is discharged from hospital and visits his \gls{gp}. The medicines that a patient was prescribed in the hospital is sometimes carried over from the hospital patient journal to FMK after his discharge, and can coincide with the prescription of new medicine by a \gls{gp}. Because the system is \gls{ec}, it is not always visible, that all updates have not yet propagated throughout. This means that conflicts can be detected after the conflicting changes were made. \textquotedblleft Conflicting medicine\textquotedblright{} may be multiple prescriptions of drugs containing the same active substance, or two drugs which interact poorly. Optimally, a doctor making or adjusting a prescription has full overview of the patient\textquoteright s existing prescriptions when he/she does so.